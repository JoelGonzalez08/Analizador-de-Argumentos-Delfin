<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Argument Suggestions Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scrollbar */
    textarea::-webkit-scrollbar { width:12px }
    textarea::-webkit-scrollbar-thumb { background:#9ca3af; border-radius:4px }
    textarea::-webkit-scrollbar-track { background:#f3f4f6 }
    /* Highlights */
    .highlight-premise { background:#bfdbfe; border-bottom:2px solid #3b82f6 }
    .highlight-conclusion { background:#fcd34d; border-bottom:2px solid #ca8a04 }
    .highlight-active { outline:2px solid #f87171 } /* on hover */
    /* Modal backdrop */
    #modal-backdrop { display:none;
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; }
    #modal { background:white; padding:1.5rem; border-radius:0.5rem; max-width:90%; max-height:80%; overflow:auto }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col">
  <main class="flex-grow max-w-7xl mx-auto p-6 md:flex md:space-x-6">
    <!-- Left editor -->
    <section class="flex flex-col flex-grow mb-6 md:mb-0">
      <div class="flex space-x-3 mb-3 p-2 bg-white rounded shadow-sm border">
        <button id="btn-bold" class="px-2 py-1 font-semibold">B</button>
        <button id="btn-italic" class="px-2 py-1 italic">I</button>
        <button id="btn-bullet" class="px-2 py-1">&#8226; List</button>
        <button id="btn-numbered" class="px-2 py-1">1. List</button>
        <button id="btn-undo" class="px-2 py-1" title="Undo">&#8630;</button>
        <button id="btn-redo" class="px-2 py-1" title="Redo">&#8631;</button>
        <button id="btn-analyze" class="ml-auto px-3 py-1 bg-blue-600 text-white rounded">Analizar</button>
      </div>
      <div id="editor" contenteditable="true" spellcheck="true"
           class="flex-grow bg-white rounded border p-4 text-lg leading-relaxed shadow-sm"
           style="min-height:320px; max-height:600px;">
        Escribe o pega tu texto argumentativo aquí…
      </div>
      <footer id="analysis-footer" class="mt-2 text-sm text-gray-500 select-none">
        0 premises · 0 conclusions detected
      </footer>
    </section>

    <!-- Right panel -->
    <aside class="w-full md:w-[600px] bg-white rounded border p-4 shadow-sm flex flex-col">
      <header class="mb-4">
        <h2 class="text-xl font-semibold">Sugerencias</h2>
      </header>
      <section id="recommendations-panel" class="flex-grow space-y-4 overflow-y-auto" aria-label="Sugerencias generadas">
        <!-- Cards injected here -->
      </section>
      <footer class="mt-4 text-xs text-gray-400 select-none">
        Last analyzed: <time id="last-analyzed">never</time>
      </footer>
    </aside>
  </main>

  <!-- Modal -->
  <div id="modal-backdrop" class="flex">
    <div id="modal">
      <button id="modal-close" class="mb-4 text-red-500">&times; Cerrar</button>
      <div id="modal-content" class="text-gray-800"></div>
    </div>
  </div>

  <script>
    // Config
    const API_BASE = "http://127.0.0.1:8000";
    
    // Formatting
    const editor = document.getElementById("editor");
    function execCmd(c){document.execCommand(c);editor.focus()}
    document.getElementById("btn-bold").onclick    = ()=> execCmd("bold");
    document.getElementById("btn-italic").onclick  = ()=> execCmd("italic");
    document.getElementById("btn-bullet").onclick  = ()=> execCmd("insertUnorderedList");
    document.getElementById("btn-numbered").onclick= ()=> execCmd("insertOrderedList");
    document.getElementById("btn-undo").onclick    = ()=> execCmd("undo");
    document.getElementById("btn-redo").onclick    = ()=> execCmd("redo");

    // Extract spans
    function extractSpans(pred, b, i){
      const spans=[]; let buf=[];
      pred.forEach(({token,label})=>{
        const inSpan = label.startsWith(b)||label.startsWith(i);
        if(inSpan) buf.push(token);
        else if(buf.length){ spans.push(buf.join(" ")); buf=[] }
        if(/[.!?]$/.test(token)&&buf.length){ spans.push(buf.join(" ")); buf=[] }
      });
      if(buf.length) spans.push(buf.join(" "));
      return spans;
    }

    // Modal controls
    const modal = document.getElementById("modal-backdrop"),
          modalContent = document.getElementById("modal-content");
    document.getElementById("modal-close").onclick = ()=> modal.style.display="none";

    // Main flow
    document.getElementById("btn-analyze").onclick = async ()=>{
      const text = editor.innerText.trim();
      if(!text) return alert("Escribe algo...");

      // predict
      const res1 = await fetch(`${API_BASE}/predict`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text})
      });
      if(!res1.ok) return alert("Error predict");
      const {prediction} = await res1.json();

      // highlight
      let html="";
      prediction.forEach(({token,label})=>{
        const cls = label.startsWith("B-P")||label.startsWith("I-P")
                  ? "highlight-premise"
                  : label.startsWith("B-C")||label.startsWith("I-C")
                  ? "highlight-conclusion":"";
        html += cls
          ? `<span class="${cls}">${token}</span> `
          : `${token} `;
      });
      editor.innerHTML=html.trim();

      // counts
      const pSpans = extractSpans(prediction,"B-P","I-P"),
            cSpans = extractSpans(prediction,"B-C","I-C");
      document.getElementById("analysis-footer").innerHTML = `
      <span class="text-blue-600 font-semibold">${pSpans.length} premises</span> · 
      <span class="text-orange-500 font-semibold">${cSpans.length} conclusions</span>
`;

      // recommend
      const res2 = await fetch(`${API_BASE}/recommend`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({premises:pSpans,conclusions:cSpans})
      });
      if(!res2.ok) return alert("Error recommend");
      const {recommendations} = await res2.json();

      // render suggestions (one card per suggestion, assume same order)
      const panel = document.getElementById("recommendations-panel");
      panel.innerHTML="";
      recommendations.forEach((rec, idx)=>{
        // determine ref phrase
        const phrase = idx < pSpans.length
                     ? pSpans[idx]
                     : cSpans[idx-pSpans.length];
        const type = idx < pSpans.length ? "PREMISE" : "CONCLUSION";
        // preview
        const preview = rec.length>60 ? rec.slice(0,60)+"…":rec;
        const card = document.createElement("div");
        card.className = "p-3 bg-gray-100 rounded shadow-sm relative";
        card.innerHTML = `
          <p class="font-semibold">${type}</p>
          <p class="italic text-sm mb-2">"${phrase}"</p>
          <p class="text-gray-800">${preview}</p>
          <button class="leer-mas text-blue-600 mt-2 underline">Leer más</button>
        `;
        // hover highlight
        card.onmouseenter = ()=>{
          Array.from(editor.querySelectorAll("span")).forEach(s=>{
            if(s.textContent.trim()===phrase) s.classList.add("highlight-active");
          });
        };
        card.onmouseleave = ()=>{
          editor.querySelectorAll(".highlight-active")
            .forEach(s=>s.classList.remove("highlight-active"));
        };
        // leer más
        card.querySelector(".leer-mas").onclick = ()=>{
          modalContent.textContent = rec;
          modal.style.display="flex";
        };
        panel.appendChild(card);
      });

      // timestamp
      const now=new Date();
      const lt=document.getElementById("last-analyzed");
      lt.textContent=now.toLocaleTimeString();
      lt.setAttribute("datetime",now.toISOString());
    };
  </script>
</body>
</html>
